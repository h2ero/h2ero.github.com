<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>PHP | h2ero</title>
  <meta name="author" content="h2ero">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="h2ero"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="h2ero" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">h2ero</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="/link">Link</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title category">PHP</h2>


  
    <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-12-18T16:00:00.000Z"><a href="/2012/12/19/2012/2012-12-19-php-mssql-stored-procedure/">Dec 19 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/12/19/2012/2012-12-19-php-mssql-stored-procedure/">PHP连接SQL Server 并使用存储过程</a></h1>
  

    </header>
    <div class="entry">
      
        <p>标题仅仅是为了SEO凑合着，这1天半都在折腾这个东西了，感觉PHP就是这些好。</p>
<h2 id="freetds">freetds</h2>
<p><a href="http://freetds.schemamania.org/" target="_blank">freeTDS</a>全名叫 free [Tabular Data Stream][1],TDS是应用层的协议，最早由Sybase Inc开发，用在自家的数据库，后来被Micrososoft用于MS Server。freeTDS则是TDS的一个开源版本实现。Python,Ruby,PHP,Perl都能够使用。有一个java实现的版本<a href="http://jtds.sourceforge.net/" title="jTDS project" target="_blank">jTDS</a>,freeTDS自身也包含有<a href="http://en.wikipedia.org/wiki/ODBC" title="ODBC" target="_blank">ODBC</a>库。</p>
<h3 id="安装">安装</h3>
<p>ubuntu debain系，sudo apt-get install freetds。mac brew install freetds。或者编译安装。</p>
<h3 id="配置">配置</h3>
<p>找到这个文件freetds.conf。然后编辑。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="preprocessor"># A typical Microsoft SQL Server 7.0 configuration      </span>
[MMS]
host = server<span class="preprocessor">.h</span>2ero<span class="preprocessor">.cn</span>
port = <span class="number">1433</span>
tds version = <span class="number">7.0</span>
</pre></td></tr></table></figure>

<h3 id="连接SQL_SERVER">连接SQL SERVER</h3>
<p>使用<a href="http://linux.die.net/man/1/tsql" title="tsql" target="_blank">tsql</a>进行连接，<code>tsql -H server.h2ero.cn -p 1433 -U username -P password</code>。通常显示过去多少秒的数字表示没有连接上。直接上了显示&gt;，然后可以执行SQL了，输入version可以查看当前的freeTDS版本。执行mssql，select @@version 回车，go 回车。然后即可执行。</p>
<h2 id="PHP_mssql">PHP mssql</h2>
<p>安装好了freeTDS后查看phpinfo信息里面有没有mssql，如果有直接就可以使用mssql_connect进行连接，如果没有需要去掉php.ini里面mssql.so或者相关dll的注释，然后重启相关服务查看。如果没有只能重新编译安装讲mmsql扩展添加进来。</p>
<h3 id="php_mssql连接">php mssql连接</h3>
<p>到了这一步直接用使用一下代码进行简单的操作，其实和mysql相关函数一样</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre><span class="preprocessor">&lt;?php</span> 

<span class="variable">$Server</span>=<span class="string">'server.h2ero.cn:1433'</span>;
<span class="variable">$dbconn</span> = mssql_connect(<span class="variable">$Server</span>, <span class="variable">$User</span>, <span class="variable">$Pass</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Couldn't connect to SQL Server on $Server"</span>);
mssql_select_db(<span class="variable">$DB</span>, <span class="variable">$dbconn</span>);
<span class="variable">$version</span> = mssql_query(<span class="string">'SELECT @@VERSION'</span>);
<span class="variable">$row</span> = mssql_fetch_array(<span class="variable">$version</span>);
<span class="keyword">echo</span> <span class="variable">$row</span>[<span class="number">0</span>];
<span class="comment">// Clean up</span>
mssql_free_result(<span class="variable">$version</span>);
</pre></td></tr></table></figure>

<h3 id="php_使用MSSQL存储过程">php 使用MSSQL存储过程</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="preprocessor">&lt;?php</span>
<span class="variable">$dbconn</span> = mssql_connect(<span class="string">'MMS'</span>, <span class="variable">$User</span>, <span class="variable">$Pass</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Couldn't connect to SQL Server on $Server"</span>);
<span class="comment">//init</span>
<span class="variable">$stmt</span>=mssql_init(<span class="string">'user_del'</span>,<span class="variable">$dbconn</span>);
mssql_bind(<span class="variable">$stmt</span>,<span class="string">'@id'</span>,<span class="variable">$user</span>[<span class="string">'id'</span>],SQLINT1,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="number">3</span>);
<span class="variable">$res</span>=mssql_execute(<span class="variable">$stmt</span>);
mssql_free_statement(<span class="variable">$stmt</span>);
</pre></td></tr></table></figure>

<p>需要注意mssql_connnect的第一个参数使用的是freeTDS里面的配置名。SQLINT1详细到这儿查看<a href="http://php.net/manual/en/mssql.constants.php" title="Predefined Constants" target="_blank">MSSQL Predefined Constants</a></p>
<h3 id="几条MSSQL">几条MSSQL</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre>#查看所有表
<span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> INFORMATION_SCHEMA.TABLES <span class="keyword">WHERE</span> TABLE_TYPE = <span class="string">'BASE TABLE'</span>;</span>
#查看所有存储过程
<span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.routines <span class="keyword">where</span> routine_type = <span class="string">'PROCEDURE;</span></span>
</pre></td></tr></table></figure>

<h3 id="MSSQL系统自带存储过程">MSSQL系统自带存储过程</h3>
<p>这些可以在tsql里面运行其中sp_helptext，sp_help对了解别人写的存储过程还是作用比较大。MySQL从5.0也开始能使用存储过程了，可以直接把存储过程理解为函数。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>exec sp_databases; <span class="comment">--查看数据库</span>
exec sp_tables;        <span class="comment">--查看表</span>
exec sp_columns student;<span class="comment">--查看列</span>
exec sp_helpIndex student;<span class="comment">--查看索引</span>
exec sp_helpConstraint student;<span class="comment">--约束</span>
exec sp_stored_procedures;
exec sp_helptext 'sp_stored_procedures';<span class="comment">--查看存储过程创建、定义语句</span>
exec sp_rename student, stuInfo;<span class="comment">--修改表、索引、列的名称</span>
exec sp_renamedb myTempDB, myDB;<span class="comment">--更改数据库名称</span>
exec sp_defaultdb 'master', 'myDB';<span class="comment">--更改登录名的默认数据库</span>
exec sp_helpdb;<span class="comment">--数据库帮助，查询数据库信息</span>
exec sp_helpdb master;
</pre></td></tr></table></figure>

<p><i class="os_date"><br>System Version: OS X 10.8 (12A269) Kernel Version: Darwin 12.0.0<br>2012-12-19 22:00:01<br></i></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:blog.h2ero.cn">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/PHP/">PHP</a><small>1</small></li>
  
    <li><a href="/categories/SQL/">SQL</a><small>1</small></li>
  
    <li><a href="/categories/hack/">hack</a><small>1</small></li>
  
    <li><a href="/categories/linux/">linux</a><small>9</small></li>
  
    <li><a href="/categories/mac/">mac</a><small>1</small></li>
  
    <li><a href="/categories/mysql/">mysql</a><small>1</small></li>
  
    <li><a href="/categories/note/">note</a><small>1</small></li>
  
    <li><a href="/categories/php/">php</a><small>8</small></li>
  
    <li><a href="/categories/plugin/">plugin</a><small>1</small></li>
  
    <li><a href="/categories/self/">self</a><small>3</small></li>
  
    <li><a href="/categories/tip/">tip</a><small>1</small></li>
  
    <li><a href="/categories/vim/">vim</a><small>1</small></li>
  
    <li><a href="/categories/web/">web</a><small>5</small></li>
  
    <li><a href="/categories/wiki/">wiki</a><small>5</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/CSS3/">CSS3</a><small>1</small></li>
  
    <li><a href="/tags/Godaddy/">Godaddy</a><small>1</small></li>
  
    <li><a href="/tags/GoogleAnalytics/">GoogleAnalytics</a><small>1</small></li>
  
    <li><a href="/tags/IE6/">IE6</a><small>1</small></li>
  
    <li><a href="/tags/MSSQL/">MSSQL</a><small>1</small></li>
  
    <li><a href="/tags/Mac/">Mac</a><small>1</small></li>
  
    <li><a href="/tags/MySQL/">MySQL</a><small>1</small></li>
  
    <li><a href="/tags/PHP/">PHP</a><small>2</small></li>
  
    <li><a href="/tags/Postfix/">Postfix</a><small>1</small></li>
  
    <li><a href="/tags/SMTP/">SMTP</a><small>1</small></li>
  
    <li><a href="/tags/SQL/">SQL</a><small>1</small></li>
  
    <li><a href="/tags/Ubuntu/">Ubuntu</a><small>1</small></li>
  
    <li><a href="/tags/Vim/">Vim</a><small>1</small></li>
  
    <li><a href="/tags/Youtube/">Youtube</a><small>1</small></li>
  
    <li><a href="/tags/Zend Studio/">Zend Studio</a><small>1</small></li>
  
    <li><a href="/tags/algin/">algin</a><small>1</small></li>
  
    <li><a href="/tags/apache/">apache</a><small>1</small></li>
  
    <li><a href="/tags/aptana/">aptana</a><small>1</small></li>
  
    <li><a href="/tags/awesom/">awesom</a><small>1</small></li>
  
    <li><a href="/tags/awesome/">awesome</a><small>1</small></li>
  
    <li><a href="/tags/codeigniter/">codeigniter</a><small>3</small></li>
  
    <li><a href="/tags/compression/">compression</a><small>1</small></li>
  
    <li><a href="/tags/convention/">convention</a><small>1</small></li>
  
    <li><a href="/tags/css/">css</a><small>2</small></li>
  
    <li><a href="/tags/dedecms/">dedecms</a><small>1</small></li>
  
    <li><a href="/tags/eclipse/">eclipse</a><small>1</small></li>
  
    <li><a href="/tags/firefox/">firefox</a><small>1</small></li>
  
    <li><a href="/tags/firegestures script/">firegestures script</a><small>1</small></li>
  
    <li><a href="/tags/framework/">framework</a><small>1</small></li>
  
    <li><a href="/tags/ftp/">ftp</a><small>1</small></li>
  
    <li><a href="/tags/fuelphp/">fuelphp</a><small>1</small></li>
  
    <li><a href="/tags/fulltext/">fulltext</a><small>1</small></li>
  
    <li><a href="/tags/git/">git</a><small>1</small></li>
  
    <li><a href="/tags/greasemonkey/">greasemonkey</a><small>1</small></li>
  
    <li><a href="/tags/h2ero/">h2ero</a><small>2</small></li>
  
    <li><a href="/tags/id_rsa.pub/">id_rsa.pub</a><small>1</small></li>
  
    <li><a href="/tags/jQuery/">jQuery</a><small>1</small></li>
  
    <li><a href="/tags/jVi/">jVi</a><small>1</small></li>
  
    <li><a href="/tags/javascript/">javascript</a><small>3</small></li>
  
    <li><a href="/tags/love/">love</a><small>1</small></li>
  
    <li><a href="/tags/loveYou/">loveYou</a><small>1</small></li>
  
    <li><a href="/tags/mac/">mac</a><small>1</small></li>
  
    <li><a href="/tags/markdown/">markdown</a><small>1</small></li>
  
    <li><a href="/tags/mysql/">mysql</a><small>1</small></li>
  
    <li><a href="/tags/netbens/">netbens</a><small>1</small></li>
  
    <li><a href="/tags/newBlog/">newBlog</a><small>1</small></li>
  
    <li><a href="/tags/newLift/">newLift</a><small>1</small></li>
  
    <li><a href="/tags/php/">php</a><small>2</small></li>
  
    <li><a href="/tags/plugin/">plugin</a><small>1</small></li>
  
    <li><a href="/tags/scp/">scp</a><small>1</small></li>
  
    <li><a href="/tags/search/">search</a><small>1</small></li>
  
    <li><a href="/tags/shell/">shell</a><small>1</small></li>
  
    <li><a href="/tags/ssh/">ssh</a><small>1</small></li>
  
    <li><a href="/tags/terminator/">terminator</a><small>1</small></li>
  
    <li><a href="/tags/transform/">transform</a><small>1</small></li>
  
    <li><a href="/tags/ubuntu/">ubuntu</a><small>2</small></li>
  
    <li><a href="/tags/uploadify/">uploadify</a><small>1</small></li>
  
    <li><a href="/tags/url rewrite/">url rewrite</a><small>1</small></li>
  
    <li><a href="/tags/vim/">vim</a><small>4</small></li>
  
    <li><a href="/tags/vimL/">vimL</a><small>1</small></li>
  
    <li><a href="/tags/vimscript/">vimscript</a><small>1</small></li>
  
    <li><a href="/tags/virtulhost/">virtulhost</a><small>1</small></li>
  
    <li><a href="/tags/vrapper/">vrapper</a><small>1</small></li>
  
    <li><a href="/tags/vsftpd/">vsftpd</a><small>1</small></li>
  
    <li><a href="/tags/wine/">wine</a><small>1</small></li>
  
    <li><a href="/tags/xev/">xev</a><small>1</small></li>
  
    <li><a href="/tags/xfce/">xfce</a><small>1</small></li>
  
    <li><a href="/tags/xmodmap/">xmodmap</a><small>1</small></li>
  
    <li><a href="/tags/you/">you</a><small>1</small></li>
  
    <li><a href="/tags/存储过程/">存储过程</a><small>1</small></li>
  
    <li><a href="/tags/油猴子/">油猴子</a><small>1</small></li>
  
    <li><a href="/tags/索引/">索引</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 h2ero
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'h2ero';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>